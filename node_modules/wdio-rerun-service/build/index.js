"use strict";

require("source-map-support/register");

const fs = require('fs');

const path = require('path');

const {
  v5: uuidv5
} = require('uuid');

const argv = require('minimist')(process.argv.slice(2));

class RerunService {
  constructor({
    ignoredTags,
    rerunDataDir,
    rerunScriptPath,
    commandPrefix
  } = {}) {
    this.nonPassingItems = [];
    this.serviceWorkerId;
    this.ignoredTags = ignoredTags ? ignoredTags : [];
    this.rerunDataDir = rerunDataDir ? rerunDataDir : "./results/rerun";
    this.rerunScriptPath = rerunScriptPath ? rerunScriptPath : "./rerun.sh";
    this.commandPrefix = commandPrefix ? commandPrefix : "";
    this.specFile = "";
  }

  before(capabilities, specs) {
    this.specFile = specs[0];
    fs.mkdirSync(this.rerunDataDir, {
      recursive: true
    });
    this.serviceWorkerId = uuidv5(`${Date.now()}`, '6ba7b810-9dad-11d1-80b4-00c04fd430c8');
  }

  afterTest(test, context, {
    error,
    result,
    duration,
    passed,
    retries
  }) {
    if (browser.config.framework !== 'cucumber' && !passed) {
      if (error && error.message) {
        this.nonPassingItems.push({
          location: this.specFile,
          failure: error.message
        });
      } else {}
    }
  }

  afterScenario(world) {
    const CUCUMBER_STATUS_MAP = ['unknown', 'passed', 'skipped', 'pending', 'undefined', 'ambiguous', 'failed'];
    const status = CUCUMBER_STATUS_MAP[world.result.status || 0];
    const scenarioLineNumber = world.gherkinDocument.feature.children.filter(child => {
      return world.pickle.astNodeIds.includes(child.scenario.id.toString());
    })[0].scenario.location.line;

    if (browser.config.framework === 'cucumber' && status !== 'passed' && status !== 'skipped') {
      const scenarioLocation = `${world.pickle.uri}:${scenarioLineNumber}`;
      const tagsList = world.pickle.tags.map(tag => tag.name);
      const service = this;

      if (this.ignoredTags && tagsList.some(ignoredTag => service.ignoredTags.includes(ignoredTag))) {} else {
        this.nonPassingItems.push({
          location: scenarioLocation,
          failure: world.result.message
        });
      }
    }
  }

  after(result, capabilities, specs) {
    if (this.nonPassingItems.length > 0) {
      fs.writeFileSync(`${this.rerunDataDir}/rerun-${this.serviceWorkerId}.json`, JSON.stringify(this.nonPassingItems));
    } else {}
  }

  onComplete(exitCode, config, capabilities, results) {
    const directoryPath = path.join(process.cwd(), `${this.rerunDataDir}`);

    if (fs.existsSync(directoryPath)) {
      const rerunFiles = fs.readdirSync(directoryPath);

      if (rerunFiles.length > 0) {
        let rerunCommand = `DISABLE_RERUN=true node_modules/.bin/wdio ${argv._[0]} `;

        if (this.commandPrefix) {
          rerunCommand = `${this.commandPrefix} ${rerunCommand}`;
        }

        let failureLocations = [];
        rerunFiles.forEach(file => {
          const json = JSON.parse(fs.readFileSync(`${this.rerunDataDir}/${file}`));
          json.forEach(failure => {
            failureLocations.push(failure.location.replace(/\\/g, "/"));
          });
        });
        const failureLocationsUnique = [...new Set(failureLocations)];
        failureLocationsUnique.forEach(failureLocation => {
          rerunCommand += ` --spec=${failureLocation}`;
        });
        fs.writeFileSync(this.rerunScriptPath, rerunCommand);
      }
    }
  }

}

;
module.exports = RerunService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJwYXRoIiwidjUiLCJ1dWlkdjUiLCJhcmd2IiwicHJvY2VzcyIsInNsaWNlIiwiUmVydW5TZXJ2aWNlIiwiY29uc3RydWN0b3IiLCJpZ25vcmVkVGFncyIsInJlcnVuRGF0YURpciIsInJlcnVuU2NyaXB0UGF0aCIsImNvbW1hbmRQcmVmaXgiLCJub25QYXNzaW5nSXRlbXMiLCJzZXJ2aWNlV29ya2VySWQiLCJzcGVjRmlsZSIsImJlZm9yZSIsImNhcGFiaWxpdGllcyIsInNwZWNzIiwibWtkaXJTeW5jIiwicmVjdXJzaXZlIiwiRGF0ZSIsIm5vdyIsImFmdGVyVGVzdCIsInRlc3QiLCJjb250ZXh0IiwiZXJyb3IiLCJyZXN1bHQiLCJkdXJhdGlvbiIsInBhc3NlZCIsInJldHJpZXMiLCJicm93c2VyIiwiY29uZmlnIiwiZnJhbWV3b3JrIiwibWVzc2FnZSIsInB1c2giLCJsb2NhdGlvbiIsImZhaWx1cmUiLCJhZnRlclNjZW5hcmlvIiwid29ybGQiLCJDVUNVTUJFUl9TVEFUVVNfTUFQIiwic3RhdHVzIiwic2NlbmFyaW9MaW5lTnVtYmVyIiwiZ2hlcmtpbkRvY3VtZW50IiwiZmVhdHVyZSIsImNoaWxkcmVuIiwiZmlsdGVyIiwiY2hpbGQiLCJwaWNrbGUiLCJhc3ROb2RlSWRzIiwiaW5jbHVkZXMiLCJzY2VuYXJpbyIsImlkIiwidG9TdHJpbmciLCJsaW5lIiwic2NlbmFyaW9Mb2NhdGlvbiIsInVyaSIsInRhZ3NMaXN0IiwidGFncyIsIm1hcCIsInRhZyIsIm5hbWUiLCJzZXJ2aWNlIiwic29tZSIsImlnbm9yZWRUYWciLCJhZnRlciIsImxlbmd0aCIsIndyaXRlRmlsZVN5bmMiLCJKU09OIiwic3RyaW5naWZ5Iiwib25Db21wbGV0ZSIsImV4aXRDb2RlIiwicmVzdWx0cyIsImRpcmVjdG9yeVBhdGgiLCJqb2luIiwiY3dkIiwiZXhpc3RzU3luYyIsInJlcnVuRmlsZXMiLCJyZWFkZGlyU3luYyIsInJlcnVuQ29tbWFuZCIsIl8iLCJmYWlsdXJlTG9jYXRpb25zIiwiZm9yRWFjaCIsImZpbGUiLCJqc29uIiwicGFyc2UiLCJyZWFkRmlsZVN5bmMiLCJyZXBsYWNlIiwiZmFpbHVyZUxvY2F0aW9uc1VuaXF1ZSIsIlNldCIsImZhaWx1cmVMb2NhdGlvbiIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNQSxFQUFFLEdBQUdDLE9BQU8sQ0FBQyxJQUFELENBQWxCOztBQUNBLE1BQU1DLElBQUksR0FBR0QsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTTtBQUFFRSxFQUFBQSxFQUFFLEVBQUVDO0FBQU4sSUFBaUJILE9BQU8sQ0FBQyxNQUFELENBQTlCOztBQUVBLE1BQU1JLElBQUksR0FBR0osT0FBTyxDQUFDLFVBQUQsQ0FBUCxDQUFvQkssT0FBTyxDQUFDRCxJQUFSLENBQWFFLEtBQWIsQ0FBbUIsQ0FBbkIsQ0FBcEIsQ0FBYjs7QUFFQSxNQUFNQyxZQUFOLENBQW1CO0FBRWZDLEVBQUFBLFdBQVcsQ0FBQztBQUFFQyxJQUFBQSxXQUFGO0FBQWVDLElBQUFBLFlBQWY7QUFBNkJDLElBQUFBLGVBQTdCO0FBQThDQyxJQUFBQTtBQUE5QyxNQUFnRSxFQUFqRSxFQUFxRTtBQUM1RSxTQUFLQyxlQUFMLEdBQXVCLEVBQXZCO0FBQ0EsU0FBS0MsZUFBTDtBQUNBLFNBQUtMLFdBQUwsR0FBbUJBLFdBQVcsR0FBR0EsV0FBSCxHQUFpQixFQUEvQztBQUNBLFNBQUtDLFlBQUwsR0FBb0JBLFlBQVksR0FBR0EsWUFBSCxHQUFrQixpQkFBbEQ7QUFDQSxTQUFLQyxlQUFMLEdBQXVCQSxlQUFlLEdBQUdBLGVBQUgsR0FBcUIsWUFBM0Q7QUFDQSxTQUFLQyxhQUFMLEdBQXFCQSxhQUFhLEdBQUdBLGFBQUgsR0FBbUIsRUFBckQ7QUFDQSxTQUFLRyxRQUFMLEdBQWdCLEVBQWhCO0FBQ0g7O0FBRURDLEVBQUFBLE1BQU0sQ0FBQ0MsWUFBRCxFQUFlQyxL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QSxJQUFJLENBQUNGLE9BQUwsQ0FBYTdDLE9BQU8sSUFBSTtBQUNwQjRDLFlBQUFBLGdCQUFnQixDQUFDOUMsSUFBakIsQ0FBc0JFLE9BQU8sQ0FBQ0QsUUFBUixDQUFpQm1ELE9BQWpCLENBQXlCLEtBQXpCLEVBQWdDLEdBQWhDLENBQXRCO0FBQ0gsV0FGRDtBQUdILFNBTEQ7QUFNQSxjQUFNQyxzQkFBc0IsR0FBRyxDQUFDLEdBQUcsSUFBSUMsR0FBSixDQUFRUixnQkFBUixDQUFKLENBQS9CO0FBQ0FPLFFBQUFBLHNCQUFzQixDQUFDTixPQUF2QixDQUErQlEsZUFBZSxJQUFJO0FBQzlDWCxVQUFBQSxZQUFZLElBQUssV0FBVVcsZUFBZ0IsRUFBM0M7QUFDSCxTQUZEO0FBR0EzRixRQUFBQSxFQUFFLENBQUNvRSxhQUFILENBQWlCLEtBQUt4RCxlQUF0QixFQUF1Q29FLFlBQXZDO0FBRUg7QUFDSjtBQUNKOztBQXZGYzs7QUF3RmxCO0FBRURZLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnJGLFlBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IHsgdjU6IHV1aWR2NSB9ID0gcmVxdWlyZSgndXVpZCcpO1xuXG5jb25zdCBhcmd2ID0gcmVxdWlyZSgnbWluaW1pc3QnKShwcm9jZXNzLmFyZ3Yuc2xpY2UoMikpO1xuXG5jbGFzcyBSZXJ1blNlcnZpY2Uge1xuXG4gICAgY29uc3RydWN0b3IoeyBpZ25vcmVkVGFncywgcmVydW5EYXRhRGlyLCByZXJ1blNjcmlwdFBhdGgsIGNvbW1hbmRQcmVmaXggfSA9IHt9KSB7XG4gICAgICAgIHRoaXMubm9uUGFzc2luZ0l0ZW1zID0gW107XG4gICAgICAgIHRoaXMuc2VydmljZVdvcmtlcklkO1xuICAgICAgICB0aGlzLmlnbm9yZWRUYWdzID0gaWdub3JlZFRhZ3MgPyBpZ25vcmVkVGFncyA6IFtdO1xuICAgICAgICB0aGlzLnJlcnVuRGF0YURpciA9IHJlcnVuRGF0YURpciA/IHJlcnVuRGF0YURpciA6IFwiLi9yZXN1bHRzL3JlcnVuXCI7XG4gICAgICAgIHRoaXMucmVydW5TY3JpcHRQYXRoID0gcmVydW5TY3JpcHRQYXRoID8gcmVydW5TY3JpcHRQYXRoIDogXCIuL3JlcnVuLnNoXCI7XG4gICAgICAgIHRoaXMuY29tbWFuZFByZWZpeCA9IGNvbW1hbmRQcmVmaXggPyBjb21tYW5kUHJlZml4IDogXCJcIjtcbiAgICAgICAgdGhpcy5zcGVjRmlsZSA9IFwiXCI7XG4gICAgfVxuXG4gICAgYmVmb3JlKGNhcGFiaWxpdGllcywgc3BlY3MpIHtcbiAgICAgICAgdGhpcy5zcGVjRmlsZSA9IHNwZWNzWzBdO1xuICAgICAgICAvLyBjb25zb2xlLmxvZyhgUmUtcnVuIHNlcnZpY2UgaXMgYWN0aXZhdGVkLiBEYXRhIGRpcmVjdG9yeTogJHt0aGlzLnJlcnVuRGF0YURpcn1gKTtcbiAgICAgICAgZnMubWtkaXJTeW5jKHRoaXMucmVydW5EYXRhRGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcbiAgICAgICAgLy8gSU5GTzogYG5hbWVzcGFjZWAgYmVsb3cgY29waWVkIGZyb206IGh0dHBzOi8vZ2l0aHViLmNvbS9rZWxla3Rpdi9ub2RlLXV1aWQvYmxvYi9tYXN0ZXIvL2xpYi92MzUuanMjTDU0OjE2XG4gICAgICAgIHRoaXMuc2VydmljZVdvcmtlcklkID0gdXVpZHY1KGAke0RhdGUubm93KCl9YCwgJzZiYTdiODEwLTlkYWQtMTFkMS04MGI0LTAwYzA0ZmQ0MzBjOCcpO1xuICAgIH1cblxuICAgIGFmdGVyVGVzdCh0ZXN0LCBjb250ZXh0LCB7IGVycm9yLCByZXN1bHQsIGR1cmF0aW9uLCBwYXNzZWQsIHJldHJpZXMgfSkge1xuICAgICAgICBpZiAoYnJvd3Nlci5jb25maWcuZnJhbWV3b3JrICE9PSAnY3VjdW1iZXInICYmICFwYXNzZWQpIHtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBSZS1ydW4gc2VydmljZSBpcyBpbnNwZWN0aW5nIG5vbi1wYXNzaW5nIHRlc3QuYCk7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhgVGVzdCBsb2NhdGlvbjogJHt0aGlzLnNwZWNGaWxlfWApO1xuICAgICAgICAgICAgaWYgKGVycm9yICYmIGVycm9yLm1lc3NhZ2UpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm5vblBhc3NpbmdJdGVtcy5wdXNoKHsgbG9jYXRpb246IHRoaXMuc3BlY0ZpbGUsIGZhaWx1cmU6IGVycm9yLm1lc3NhZ2UgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwiVGhlIG5vbi1wYXNzaW5nIHRlc3QgZGlkIG5vdCBjb250YWluIGFueSBlcnJvciBtZXNzYWdlLCBpdCBjb3VsZCBub3QgYmUgYWRkZWQgZm9yIHJlLXJ1bi5cIilcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIEV4ZWN1dGVkIGFmdGVyIGEgQ3VjdW1iZXIgc2NlbmFyaW8gZW5kcy5cbiAgICBhZnRlclNjZW5hcmlvKHdvcmxkKSB7XG4gICAgICAgIGNvbnN0IENVQ1VNQkVSX1NUQVRVU19NQVAgPSBbJ3Vua25vd24nLCAncGFzc2VkJywgJ3NraXBwZWQnLCAncGVuZGluZycsICd1bmRlZmluZWQnLCAnYW1iaWd1b3VzJywgJ2ZhaWxlZCddXG4gICAgICAgIGNvbnN0IHN0YXR1cyA9IENVQ1VNQkVSX1NUQVRVU19NQVBbd29ybGQucmVzdWx0LnN0YXR1cyB8fCAwXVxuICAgICAgICBjb25zdCBzY2VuYXJpb0xpbmVOdW1iZXIgPSB3b3JsZC5naGVya2luRG9jdW1lbnQuZmVhdHVyZS5jaGlsZHJlbi5maWx0ZXIoKGNoaWxkKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gd29ybGQucGlja2xlLmFzdE5vZGVJZHMuaW5jbHVkZXMoY2hpbGQuc2NlbmFyaW8uaWQudG9TdHJpbmcoKSk7XG4gICAgICAgIH0pWzBdLnNjZW5hcmlvLmxvY2F0aW9uLmxpbmU7XG5cbiAgICAgICAgaWYgKGJyb3dzZXIuY29uZmlnLmZyYW1ld29yayA9PT0gJ2N1Y3VtYmVyJyAmJiAoc3RhdHVzICE9PSAncGFzc2VkJyAmJiBzdGF0dXMgIT09ICdza2lwcGVkJykpIHtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBSZS1ydW4gc2VydmljZSBpcyBpbnNwZWN0aW5nIG5vbi1wYXNzaW5nIHNjZW5hcmlvLmApO1xuICAgICAgICAgICAgY29uc3Qgc2NlbmFyaW9Mb2NhdGlvbiA9IGAke3dvcmxkLnBpY2tsZS51cml9OiR7c2NlbmFyaW9MaW5lTnVtYmVyfWA7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhgU2NlbmFyaW8gbG9jYXRpb246ICR7c2NlbmFyaW9Mb2NhdGlvbn1gKTtcbiAgICAgICAgICAgIGNvbnN0IHRhZ3NMaXN0ID0gd29ybGQucGlja2xlLnRhZ3MubWFwKHRhZyA9PiB0YWcubmFtZSk7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhgU2NlbmFyaW8gdGFnczogJHt0YWdzTGlzdH1gKTtcbiAgICAgICAgICAgIGNvbnN0IHNlcnZpY2UgPSB0aGlzO1xuICAgICAgICAgICAgaWYgKHRoaXMuaWdub3JlZFRhZ3MgJiYgdGFnc0xpc3Quc29tZShpZ25vcmVkVGFnID0+IHNlcnZpY2UuaWdub3JlZFRhZ3MuaW5jbHVkZXMoaWdub3JlZFRhZykpKSB7XG4gICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYFJlLXJ1biBzZXJ2aWNlIHdpbGwgaWdub3JlIHRoZSBjdXJyZW50IHNjZW5hcmlvIHNpbmNlIGl0IGluY2x1ZGVzIG9uZSBvZiB0aGUgaWdub3JlZCB0YWdzOiAke3RoaXMuaWdub3JlZFRhZ3N9YCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMubm9uUGFzc2luZ0l0ZW1zLnB1c2goeyBsb2NhdGlvbjogc2NlbmFyaW9Mb2NhdGlvbiwgZmFpbHVyZTogd29ybGQucmVzdWx0Lm1lc3NhZ2UgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhZnRlcihyZXN1bHQsIGNhcGFiaWxpdGllcywgc3BlY3MpIHtcbiAgICAgICAgaWYgKHRoaXMubm9uUGFzc2luZ0l0ZW1zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMoYCR7dGhpcy5yZXJ1bkRhdGFEaXJ9L3JlcnVuLSR7dGhpcy5zZXJ2aWNlV29ya2VySWR9Lmpzb25gLCBKU09OLnN0cmluZ2lmeSh0aGlzLm5vblBhc3NpbmdJdGVtcykpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ1JlLXJ1biBzZXJ2aWNlIGRpZCBub3QgZGV0ZWN0IGFueSBub24tcGFzc2luZyBzY2VuYXJpb3Mgb3IgdGVzdHMuJyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBvbkNvbXBsZXRlKGV4aXRDb2RlLCBjb25maWcsIGNhcGFiaWxpdGllcywgcmVzdWx0cykge1xuICAgICAgICBjb25zdCBkaXJlY3RvcnlQYXRoID0gcGF0aC5qb2luKHByb2Nlc3MuY3dkKCksIGAke3RoaXMucmVydW5EYXRhRGlyfWApO1xuICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhkaXJlY3RvcnlQYXRoKSkge1xuICAgICAgICAgICAgY29uc3QgcmVydW5GaWxlcyA9IGZzLnJlYWRkaXJTeW5jKGRpcmVjdG9yeVBhdGgpO1xuICAgICAgICAgICAgaWYgKHJlcnVuRmlsZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIGxldCByZXJ1bkNvbW1hbmQgPSBgRElTQUJMRV9SRVJVTj10cnVlIG5vZGVfbW9kdWxlcy8uYmluL3dkaW8gJHthcmd2Ll9bMF19IGA7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuY29tbWFuZFByZWZpeCkge1xuICAgICAgICAgICAgICAgICAgICByZXJ1bkNvbW1hbmQgPSBgJHt0aGlzLmNvbW1hbmRQcmVmaXh9ICR7cmVydW5Db21tYW5kfWA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGxldCBmYWlsdXJlTG9jYXRpb25zID0gW107XG4gICAgICAgICAgICAgICAgcmVydW5GaWxlcy5mb3JFYWNoKGZpbGUgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBqc29uID0gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMoYCR7dGhpcy5yZXJ1bkRhdGFEaXJ9LyR7ZmlsZX1gKSk7XG4gICAgICAgICAgICAgICAgICAgIGpzb24uZm9yRWFjaChmYWlsdXJlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWx1cmVMb2NhdGlvbnMucHVzaChmYWlsdXJlLmxvY2F0aW9uLnJlcGxhY2UoL1xcXFwvZywgXCIvXCIpKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgY29uc3QgZmFpbHVyZUxvY2F0aW9uc1VuaXF1ZSA9IFsuLi5uZXcgU2V0KGZhaWx1cmVMb2NhdGlvbnMpXTtcbiAgICAgICAgICAgICAgICBmYWlsdXJlTG9jYXRpb25zVW5pcXVlLmZvckVhY2goZmFpbHVyZUxvY2F0aW9uID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVydW5Db21tYW5kICs9IGAgLS1zcGVjPSR7ZmFpbHVyZUxvY2F0aW9ufWA7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyh0aGlzLnJlcnVuU2NyaXB0UGF0aCwgcmVydW5Db21tYW5kKTtcbiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhgUmUtcnVuIHNjcmlwdCBoYXMgYmVlbiBnZW5lcmF0ZWQgQCAke3RoaXMucmVydW5TY3JpcHRQYXRofWApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufTtcblxubW9kdWxlLmV4cG9ydHMgPSBSZXJ1blNlcnZpY2U7XG4iXX0=